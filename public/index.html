<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akatsuki Bot Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; margin-top: 30px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .status-active { color: #198754; font-weight: bold; }
        .status-inactive { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Akatsuki Bot Management</h1>
        <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="card p-4">
        <h3>Login Required</h3>
        <div class="input-group mb-3">
            <input type="password" id="adminToken" class="form-control" placeholder="Admin Token">
            <button class="btn btn-primary" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" style="display:none;">
        
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="subs-tab" data-bs-toggle="tab" data-bs-target="#subs" type="button" role="tab">Subscriptions</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">Logs</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Subscriptions Tab -->
            <div class="tab-pane fade show active" id="subs" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">Add New</button>
                    <button class="btn btn-secondary" onclick="syncRoles()">Sync Roles</button>
                </div>
                <div class="card p-3">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Server ID</th>
                                <th>User ID</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subsTableBody">
                            <!-- Rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
                 <button class="btn btn-sm btn-outline-secondary mb-2" onclick="fetchLogs()">Refresh Logs</button>
                <div class="card p-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Server ID</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Rows here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label>Server ID</label>
                    <input type="text" class="form-control" id="addServerId">
                </div>
                <div class="mb-2">
                    <label>User ID</label>
                    <input type="text" class="form-control" id="addUserId">
                </div>
                <div class="mb-2">
                    <label>Tier</label>
                    <select class="form-control" id="addTier">
                        <option value="Pro">Pro</option>
                        <option value="Pro+">Pro+</option>
                        <option value="Free">Free</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label>Duration</label>
                    <input type="text" class="form-control" id="addDuration" placeholder="30d, 1y">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="addSubscription()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editServerId">
                
                <h6>Extend</h6>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="extendDuration" placeholder="30d">
                    <button class="btn btn-outline-primary" onclick="extendSub()">Extend</button>
                </div>

                <h6>Change Tier</h6>
                <div class="input-group mb-3">
                     <select class="form-control" id="editTier">
                        <option value="Pro">Pro</option>
                        <option value="Pro+">Pro+</option>
                        <option value="Free">Free</option>
                    </select>
                    <button class="btn btn-outline-secondary" onclick="updateTier()">Update</button>
                </div>

                <h6>Update Notes</h6>
                <div class="mb-3">
                    <textarea class="form-control" id="editNotes" rows="3"></textarea>
                    <button class="btn btn-outline-secondary mt-1 btn-sm" onclick="updateNotes()">Save Note</button>
                </div>

                <hr>
                <button class="btn btn-danger w-100 mb-2" onclick="cancelSub()">Cancel Subscription</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = '/api';
    let token = localStorage.getItem('admin_token');

    if (token) {
        showDashboard();
    }

    function login() {
        token = document.getElementById('adminToken').value;
        if (token) {
            localStorage.setItem('admin_token', token);
            showDashboard();
        }
    }

    function logout() {
        localStorage.removeItem('admin_token');
        location.reload();
    }

    function showDashboard() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';
        fetchSubscriptions();
        fetchLogs();
    }

    async function apiRequest(endpoint, method = 'GET', body = null) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': token
        };
        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        const res = await fetch(API_URL + endpoint, options);
        if (res.status === 401) {
            alert('Unauthorized. Please login again.');
            logout();
            return null;
        }
        return res.json();
    }

    async function fetchSubscriptions() {
        const data = await apiRequest('/subscriptions');
        if (!data) return;
        const tbody = document.getElementById('subsTableBody');
        tbody.innerHTML = '';
        data.forEach(sub => {
            const tr = document.createElement('tr');
            const expiry = sub.expiry_date ? new Date(sub.expiry_date).toLocaleDateString() : 'No Expiry';
            const statusClass = sub.is_active ? 'status-active' : 'status-inactive';
            
            tr.innerHTML = `
                <td>${sub.server_id}</td>
                <td>${sub.user_id}</td>
                <td><span class="badge bg-info text-dark">${sub.plan_tier}</span></td>
                <td class="${statusClass}">${sub.is_active ? 'Active' : 'Inactive'}</td>
                <td>${expiry}</td>
                <td><small>${(sub.notes || '').replace(/\n/g, '<br>')}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-dark" onclick="openEditModal('${sub.server_id}', '${sub.plan_tier}', '${encodeURIComponent(sub.notes || '')}')">Edit</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchLogs() {
        const data = await apiRequest('/logs');
        if (!data) return;
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = '';
        data.forEach(log => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(log.created_at).toLocaleString()}</td>
                <td>${log.server_id}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function addSubscription() {
        const body = {
            server_id: document.getElementById('addServerId').value,
            user_id: document.getElementById('addUserId').value,
            tier: document.getElementById('addTier').value,
            duration: document.getElementById('addDuration').value
        };
        const res = await apiRequest('/subscriptions', 'POST', body);
        if (res && res.success) {
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            fetchSubscriptions();
             // Clear inputs
            document.getElementById('addServerId').value = '';
            document.getElementById('addUserId').value = '';
            document.getElementById('addDuration').value = '';
        } else {
            alert(res.error || 'Failed');
        }
    }

    function openEditModal(serverId, tier, notes) {
        document.getElementById('editServerId').value = serverId;
        document.getElementById('editTier').value = tier;
        document.getElementById('editNotes').value = decodeURIComponent(notes);
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    async function extendSub() {
        const id = document.getElementById('editServerId').value;
        const duration = document.getElementById('extendDuration').value;
        const res = await apiRequest(`/subscriptions/${id}`, 'PUT', { action: 'extend', duration });
        if (res && res.success) {
            alert('Extended!');
            fetchSubscriptions();
        } else {
            alert('Failed');
        }
    }

    async function updateTier() {
        const id = document.getElementById('editServerId').value;
        const tier = document.getElementById('editTier').value;
        const res = await apiRequest(`/subscriptions/${id}`, 'PUT', { action: 'update_tier', tier });
        if (res && res.success) {
            alert('Updated!');
            fetchSubscriptions();
        }
    }

    async function updateNotes() {
        const id = document.getElementById('editServerId').value;
        const notes = document.getElementById('editNotes').value;
        const res = await apiRequest(`/subscriptions/${id}`, 'PUT', { action: 'update_note', notes });
        if (res && res.success) {
             alert('Updated!');
            fetchSubscriptions();
        }
    }

    async function cancelSub() {
        if (!confirm('Are you sure you want to cancel?')) return;
        const id = document.getElementById('editServerId').value;
        const res = await apiRequest(`/subscriptions/${id}`, 'DELETE');
        if (res && res.success) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            fetchSubscriptions();
        }
    }
    
    async function syncRoles() {
        if(!confirm('Start Role Sync?')) return;
         const res = await apiRequest('/sync', 'POST');
         if(res) {
             alert(`Sync Completed. Updated: ${res.updated || 0}`);
             fetchSubscriptions();
             fetchLogs();
         }
    }
</script>
</body>
</html>
